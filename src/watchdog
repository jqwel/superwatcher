#! /usr/bin/env bash

#prefer the local forever, but fall back to the path
SCRIPT_PATH="$( readlink "${BASH_SOURCE[0]}" )"
if [ -z "${SCRIPT_PATH}" ]; then
    SCRIPT_PATH="${BASH_SOURCE[0]}"
fi
DIR="$( cd "$( dirname "${SCRIPT_PATH}" )" && pwd )"
export PATH="${DIR}/../node_modules/.bin":${PATH}

#tracking that we ran
touch "${SUPERWATCHER_HOME}/watchdog_run"
echo $USER > "${SUPERWATCHER_HOME}/user"

LOG_DIR="${SUPERWATCHER_HOME}/var/log"
if [ ! -d "${LOG_DIR}" ]; then
  mkdir -p "${LOG_DIR}"
fi

#we need to make sure things are still running
RUNNING=`forever list | grep  "${LOG_DIR}"`
if [[ ( -z "${RUNNING}" ) || ( "${1}" ) ]]; then
  forever start --append -l "${LOG_DIR}/forever.log" -o "${LOG_DIR}/out.log" \
    -e "${LOG_DIR}/err.log" -c bash "${SUPERWATCHER_HOME}/main"
fi

#check on all watch repositories for updates
if [ -f "${SUPERWATCHER_HOME}/watch" ]; then
  cat "${SUPERWATCHER_HOME}/watch" | xargs -I % "${SUPERWATCHER_HOME}/update_repo_as_needed" %
fi

#special case here, restart if the environment has changed
if [ -f "${SUPERWATCHER_HOME}/environment" ]; then
    CHANGES=$(diff "${SUPERWATCHER_HOME}/environment" "${SUPERWATCHER_HOME}/environment.prior")
    if [ ! -z "${CHANGES}" ]; then
      echo "environment changed ${CURRENT_SIGNATURE} ${PRIOR_SIGNATURE}"
      forever restart "${SUPERWATCHER_HOME}/main"
    fi
    cp "${SUPERWATCHER_HOME}/environment" "${SUPERWATCHER_HOME}/environment.prior"
fi
